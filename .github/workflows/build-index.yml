permissions:
  contents: write

name: Build index.json

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate index.json
        run: |
          python3 << 'EOF'
          import os, json

          EXCLUDE = {'.git', '.github', 'addon-artwork'}
          IMAGE_EXTS = ('.jpg', '.jpeg')

          index = {}
          for d in sorted(os.listdir('.')):
              if d in EXCLUDE or not os.path.isdir(d):
                  continue
              images = [f for f in sorted(os.listdir(d)) if f.lower().endswith(IMAGE_EXTS)]
              if images:
                  index[d] = images

          with open('index.json', 'w') as f:
              json.dump(index, f, indent=2)
          EOF

      - name: Commit index.json
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add index.json
          git commit -m "Auto-update index.json" || true
          git push

