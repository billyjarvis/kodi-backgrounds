name: Build index.json

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate index.json
        run: |
          python3 << 'EOF'
          import os, json

          EXCLUDE = {'.git', '.github', 'addon-artwork'}
          IMAGE_EXTS = ('.jpg', '.jpeg', '.JPG', '.JPEG')

          index = {}

          for top in sorted(os.listdir('.')):
              if top in EXCLUDE or not os.path.isdir(top):
                  continue

              images = []
              for root, _, files in os.walk(top):
                  for f in sorted(files):
                      if f.lower().endswith(IMAGE_EXTS):
                          images.append(os.path.relpath(os.path.join(root, f), top))

              if images:
                  index[top] = images

          with open('index.json', 'w') as f:
              json.dump(index, f, indent=2)
          EOF

      - name: Commit index.json
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add index.json
          git commit -m "Auto-update index.json" || true
          git push
